worker_processes auto;

events {

	worker_connections 1024;
}

http {

	include mime.types;
	default_type application/octet-stream;
	sendfile on;

	# WebSocket Support (Required for Dozzle & Kafka UI)
	map $http_upgrade $connection_upgrade {

		default upgrade;
		'' close;
	}

	# Docker DNS Resolver
	resolver 127.0.0.11 valid=30s;

	# =====================================================
	# Cloudflare IP detection
	# =====================================================
	geo $is_cloudflare {

		default 0;

		# Cloudflare IPv4 ranges
		173.245.48.0/20 1;
		103.21.244.0/22 1;
		103.22.200.0/22 1;
		103.31.4.0/22 1;
		141.101.64.0/18 1;
		108.162.192.0/18 1;
		190.93.240.0/20 1;
		188.114.96.0/20 1;
		197.234.240.0/22 1;
		198.41.128.0/17 1;
		162.158.0.0/15 1;
		104.16.0.0/13 1;
		104.24.0.0/14 1;
		172.64.0.0/13 1;
		131.0.72.0/22 1;
	}

	# --- HTTP REDIRECT ---
	server {

		listen 80;
		server_name octanebrew.dev *.octanebrew.dev;
		location /.well-known/acme-challenge/ {

			root /var/www/certbot;
		}
		location / {

			return 301 https://$host$request_uri;
		}
	}

	# --- SHARED SSL SETTINGS ---

	ssl_certificate /etc/letsencrypt/live/octanebrew.dev/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/octanebrew.dev/privkey.pem;
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_session_cache shared:SSL:10m;

	# --- 1. MAIN SITE (Video Player) ---
	server {

		listen 443 ssl;
		http2 on;
		server_name octanebrew.dev www.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			root /var/www/html;
			index index.html;
		}

		location /video/ {

			alias /var/www/video/;
			autoindex on;

			# Simple CORS headers
			add_header 'Access-Control-Allow-Origin' '*' always;
			add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
			add_header 'Access-Control-Allow-Headers' 'Range' always;
			add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

			# Handle preflight OPTIONS requests
			if ($request_method = 'OPTIONS') {

				add_header 'Access-Control-Allow-Origin' '*';
				add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
				add_header 'Access-Control-Allow-Headers' 'Range';
				add_header 'Content-Length' 0;
				add_header 'Content-Type' text/plain;
				return 204;
			}

			location ~* \.(m3u8)$ {

				expires -1;
				# CORS headers for HLS manifest
				add_header 'Access-Control-Allow-Origin' '*' always;
				add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
				add_header 'Access-Control-Allow-Headers' 'Range, Origin, Content-Type' always;
				add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
			}

			location ~* \.(ts)$ {

				expires 1y;
				add_header Cache-Control "public";
				# CORS headers for HLS segments
				add_header 'Access-Control-Allow-Origin' '*' always;
				add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
				add_header 'Access-Control-Allow-Headers' 'Range, Origin, Content-Type' always;
				add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
			}
		}

	}

	# --- 2. GRAFANA ---
	server {

		listen 443 ssl;
		http2 on;
		server_name grafana.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_grafana grafana;
			proxy_pass http://$upstream_grafana:3000;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}
	}

	# --- 3. KIBANA ---
	server {

		listen 443 ssl;
		http2 on;
		server_name kibana.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_kibana kibana;
			proxy_pass http://$upstream_kibana:5601;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}
	}

	# --- 4. KAFKA UI ---
	server {

		listen 443 ssl;
		http2 on;
		server_name kafka.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_kafka_ui kafka-ui;
			proxy_pass http://$upstream_kafka_ui:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}
	}

	# --- 5. DOZZLE (Container Logs) ---
	server {

		listen 443 ssl;
		http2 on;
		server_name dozzle.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_dozzle dozzle;
			proxy_pass http://$upstream_dozzle:8080;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_set_header Host $host;
		}
	}

	# --- 6. ELASTICSEARCH API ---
	server {

		listen 443 ssl;
		http2 on;
		server_name elastic.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_elastic elasticsearch;
			proxy_pass http://$upstream_elastic:9200;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}
	}

	# --- 7. RTMP STATS ---
	server {

		listen 443 ssl;
		http2 on;
		server_name stats.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_stats live-ingest;
			proxy_pass http://$upstream_stats:8082/stat;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}

		location /stat.xsl {

			set $upstream_stats live-ingest;
			proxy_pass http://$upstream_stats:8082/stat.xsl;
		}

		location /style.css {

			root /var/www/html;
		}
	}
	# --- 8. OPENSTREAM PLATFORM ---
	server {

		listen 443 ssl;
		server_name openstream.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_frontend openstream-web;
			proxy_pass http://$upstream_frontend:3000;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /api/ {

			set $upstream_backend openstream-api;
			proxy_pass http://$upstream_backend:4000;
			# proxy_pass http://host.openstream.internal:9901/; # LOCAL DEV

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /socket.io/ {

			set $upstream_backend openstream-api;
			proxy_pass http://$upstream_backend:4000/socket.io/;
			# proxy_pass http://host.openstream.internal:9901/socket.io/; # LOCAL DEV

			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_set_header Host $host;

			# Allow WebSocket Cross-Origin
			proxy_set_header Origin "";
			proxy_set_header X-Forwarded-Host $host;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /ingest {

			set $upstream_backend openstream-api;

			proxy_pass http://$upstream_backend:4000;
			# proxy_pass http://host.openstream.internal:4000/; # LOCAL DEV

			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_read_timeout 86400s;
			proxy_send_timeout 86400s;
		}
	}

	# --- 9. CONDUIT WEB ---
	server {

		listen 443 ssl;
		http2 on;
		server_name conduit.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_conduit_web conduit-web;
			proxy_pass http://$upstream_conduit_web:3001;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
	}

	# --- 10. CONDUIT API ---
	server {

		listen 443 ssl;
		http2 on;
		server_name api.conduit.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		location / {

			set $upstream_conduit_api conduit-api;
			proxy_pass http://$upstream_conduit_api:4001;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
	}

	# --- 11. OBJECT STORAGE (MinIO) ---
	server {

		listen 443 ssl;
		http2 on;
		server_name storage.octanebrew.dev;

		if ($is_cloudflare = 0) {

			return 444;
		}

		client_max_body_size 100M;

		location / {

			set $upstream_minio minio;
			proxy_pass http://$upstream_minio:9000;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			proxy_connect_timeout 300;
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			chunked_transfer_encoding off;
		}
	}
}