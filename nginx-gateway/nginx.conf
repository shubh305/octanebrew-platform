worker_processes auto;

events {

	worker_connections 1024;
}

http {

	include mime.types;
	default_type application/octet-stream;
	sendfile on;

	# WebSocket Support (Required for Dozzle & Kafka UI)
	map $http_upgrade $connection_upgrade {

		default upgrade;
		'' close;
	}

	# Docker DNS Resolver
	resolver 127.0.0.11 valid=30s;

	# --- HTTP REDIRECT ---
	server {

		listen 80;
		server_name octanebrew.dev *.octanebrew.dev;
		location /.well-known/acme-challenge/ {

			root /var/www/certbot;
		}
		location / {

			return 301 https://$host$request_uri;
		}
	}

	# --- SHARED SSL SETTINGS ---
	# ssl_certificate /etc/letsencrypt/live/octanebrew.dev/fullchain.pem; # OLD
	# ssl_certificate_key /etc/letsencrypt/live/octanebrew.dev/privkey.pem; # OLD
	
	# TEMP: Certbot copy issue fix
	ssl_certificate /etc/letsencrypt/archive/octanebrew.dev/fullchain2.pem;
	ssl_certificate_key /etc/letsencrypt/archive/octanebrew.dev/privkey2.pem;
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_session_cache shared:SSL:10m;

	# --- 1. MAIN SITE (Video Player) ---
	server {

		listen 443 ssl;
		http2 on;
		server_name octanebrew.dev www.octanebrew.dev;

		location / {
			root /var/www/html;
			index index.html;
		}

		location /video/ {

			alias /var/www/video/;
			autoindex on;

			# Simple CORS headers
			add_header 'Access-Control-Allow-Origin' '*' always;
			add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
			add_header 'Access-Control-Allow-Headers' 'Range' always;
			add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

			# Handle preflight OPTIONS requests
			if ($request_method = 'OPTIONS') {

				add_header 'Access-Control-Allow-Origin' '*';
				add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
				add_header 'Access-Control-Allow-Headers' 'Range';
				add_header 'Content-Length' 0;
				add_header 'Content-Type' text/plain;
				return 204;
			}

			location ~* \.(m3u8)$ {
				expires -1;
			}

			location ~* \.(ts)$ {
				expires 1y;
				add_header Cache-Control "public";
			}
		}

		# --- API & BACKEND ---
		location /api/ {
			# 'openstream-api' is the container name of the NestJS backend
			set $upstream_backend openstream-api;
			proxy_pass http://$upstream_backend:3000/;
			# proxy_pass http://host.openstream.internal:9901/; # LOCAL DEV
			
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /socket.io/ {
			set $upstream_backend openstream-api;
			proxy_pass http://$upstream_backend:3000/socket.io/;
			# proxy_pass http://host.openstream.internal:9901/socket.io/; # LOCAL DEV

			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_set_header Host $host;
		}
	}

	# --- 2. GRAFANA ---
	server {

		listen 443 ssl;
		http2 on;
		server_name grafana.octanebrew.dev;

		location / {

			set $upstream_grafana grafana;
			proxy_pass http://$upstream_grafana:3000;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}
	}

	# --- 3. KIBANA ---
	server {

		listen 443 ssl;
		http2 on;
		server_name kibana.octanebrew.dev;

		location / {

			set $upstream_kibana kibana;
			proxy_pass http://$upstream_kibana:5601;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}
	}

	# --- 4. KAFKA UI ---
	server {

		listen 443 ssl;
		http2 on;
		server_name kafka.octanebrew.dev;

		location / {

			set $upstream_kafka_ui kafka-ui;
			proxy_pass http://$upstream_kafka_ui:8080;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}
	}

	# --- 5. DOZZLE (Container Logs) ---
	server {

		listen 443 ssl;
		http2 on;
		server_name dozzle.octanebrew.dev;

		location / {

			set $upstream_dozzle dozzle;
			proxy_pass http://$upstream_dozzle:8080;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection $connection_upgrade;
			proxy_set_header Host $host;
		}
	}

	# --- 6. ELASTICSEARCH API ---
	server {

		listen 443 ssl;
		http2 on;
		server_name elastic.octanebrew.dev;

		location / {

			set $upstream_elastic elasticsearch;
			proxy_pass http://$upstream_elastic:9200;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}
	}

	# --- 7. RTMP STATS ---
	server {

		listen 443 ssl;
		http2 on;
		server_name stats.octanebrew.dev;

		# ssl_certificate /etc/letsencrypt/live/octanebrew.dev/fullchain.pem; # OLD
		# ssl_certificate_key /etc/letsencrypt/live/octanebrew.dev/privkey.pem; # OLD

		# TEMP: Certbot copy issue fix
		ssl_certificate /etc/letsencrypt/archive/octanebrew.dev/fullchain2.pem;
		ssl_certificate_key /etc/letsencrypt/archive/octanebrew.dev/privkey2.pem;

		location / {

			set $upstream_stats live-ingest;
			proxy_pass http://$upstream_stats:8082/stat;

			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
		}

		location /stat.xsl {

			set $upstream_stats live-ingest;
			proxy_pass http://$upstream_stats:8082/stat.xsl;
		}

		location /style.css {
			root /var/www/html;
		}
	}
}